LMN Foreman Templates
=========================
This is what is on the LMN kickstart server eg. 01-00-33-22-44-33-33
There is no default file

DEFAULT menu
PROMPT 0
MENU TITLE PXE Menu
TIMEOUT 200
TOTALTIMEOUT 6000
ONTIMEOUT local

LABEL local
     MENU LABEL (local)
     MENU DEFAULT
     LOCALBOOT 0


This is what is in the LMN foreman GUI
These get assigned to an operating system


LMN PXE Default

default linux
label linux
kernel <%= @kernel %>
append initrd=<%= @initrd %> ks=<%= foreman_url("provision")%> ksdevice=<%= @host.mac %> network kssendmac

LMN RHEL Default
install
<%= @mediapath %>
lang en_GB
selinux --disabled
keyboard uk
skipx
network --bootproto static --ip <%= @host.ip %> --netmask <%= @host.subnet.mask %> --gateway <%= @host.subnet.gateway %> --nameserver <%= @host.subnet.dns_primary %> --hostname <%= @host %> --noipv6
rootpw --iscrypted <%= root_pass %>
firewall --disabled
authconfig --useshadow --passalgo=sha256 --kickstart
timezone GMT
services --disabled autofs,gpm,sendmail,cups,iptables,ip6tables,auditd,arptables_jf,xfs,pcmcia,isdn,rawdevices,hpoj,bluetooth,openibd,avahi-daemon,avahi-dnsconfd,hidd,hplip,pcscd,restorecond,mcstrans,rhnsd,yum-updatesd

repo --name=os --baseurl=http://yum.prd.lastminute.com/base/rhel<%= @host.operatingsystem.major %>/x86_64/os/kickstart/
repo --name=common --baseurl=http://yum.prd.lastminute.com/base/rhel<%= @host.operatingsystem.major %>/x86_64/common/0/
repo --name=puppet --baseurl=http://yum.prd.lastminute.com/external/rhel<%= @host.operatingsystem.major %>/x86_64/puppet/0/
repo --name=puppet-dependencies --baseurl=http://yum.prd.lastminute.com/external/rhel<%= @host.operatingsystem.major %>/x86_64/puppet-dependencies/0/
<% if @host.operatingsystem.major.to_i > 5 -%>
repo --name=puppet-misc --baseurl=http://yum.prd.lastminute.com/misc/rhel<%= @host.operatingsystem.major %>/x86_64/puppet/
<% end -%>

bootloader --location=mbr --append="nofb quiet splash=quiet" <%= grub_pass %>
key --skip

# FIXME: wclarke - May be unnecessary
<% if @dynamic -%>
%include /tmp/diskpart.cfg
<% else -%>
<%= @host.diskLayout %>
<% end -%>

text
reboot

%packages --ignoremissing
yum
ntp
wget
dhclient
compat-libstdc++-33
net-snmp
lm_sensors
xorg-x11-deprecated-libs
compat-libstdc++-296
sharutils
rsync
strace
screen
curl
sysstat
vim-enhanced
openssl
db4
puppet
<% if @host.operatingsystem.major.to_i > 5 -%>
redhat-lsb-core
<% else -%>
redhat-lsb
<% end %>
-subscription-manager
-logwatch
-smartmontools
-kudzu
-gpm
-pcmciautils
-ypbind
-anacron
-yum-updatesd
-yum-rhn-plugin 
-rhn-client-tools 
-rhn-setup 
-rhn-check 
-rhnsd
-postfix

# FIXME: wclarke - May be unnecessary
<% if @dynamic -%>
%pre
<%= @host.diskLayout %>
<% end -%>
%end

%post --nochroot
exec < /dev/tty3 > /dev/tty3
#changing to VT 3 so that we can see whats going on....
/usr/bin/chvt 3
(
cp -va /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
/usr/bin/chvt 1
) 2>&1 | tee /mnt/sysimage/root/install.postnochroot.log
%end

%post
logger "Starting anaconda <%= @host %> postinstall"
exec < /dev/tty3 > /dev/tty3
#changing to VT 3 so that we can see whats going on....
/usr/bin/chvt 3
(
#update local time
echo "updating system time"
/usr/sbin/ntpdate -sub <%= @host.params["ntp-server"] || "ntp.prd.lastminute.com" %>
/usr/sbin/hwclock --systohc

# and add the puppet package
yum -t -y -e 0 install puppet

echo "Configuring puppet"
cat > /etc/puppet/puppet.conf << EOF
<%= snippets "puppet.conf" %>
EOF

# FIXME: puppet server needs to be changed to a variable in the future
puppet agent --waitforcert 10 --certname <%= @host %> --server lmn-prd-puppet001.prd.lastminute.com --onetime --no-daemonize --test --ssldir /var/lib/puppet/ssl --environment prd --report true --pluginsync true

sync

# Inform the build system that we are done.
echo "Informing Foreman that we are built"
wget -q -O /dev/null --no-check-certificate <%= foreman_url %>
# Sleeping an hour for debug
) 2>&1 | tee /root/install.post.log
exit 0
%end
